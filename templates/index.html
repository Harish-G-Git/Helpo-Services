<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helpo Services</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
</head>
<body>

<header class="navbar navbar-expand-lg sticky-top custom-navbar">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="navbar-brand m-0 text-white fs-5">Helpo Services</h1>
    <div class="nav-actions">
      <a href="/">Home</a>
      {% if session.get('vendor_logged_in') %}
        <a href="/vendor/dashboard">Dashboard</a>
        <a href="/vendor/leads">Leads</a>
        <a href="/vendor/profile">Profile</a>
        <a href="/vendor/logout" class="text-danger">Logout</a>
      {% else %}
        <a href="/vendor">Register</a>
        <a href="/vendor/login">Login</a>
      {% endif %}
    </div>
  </div>
</header>

<!-- Search Bar -->
<div class="container my-3">
  <div class="search-bar">
    <div class="search-input-box me-2">
      <input type="text" class="form-control" id="searchInput" placeholder="Search service" />
    </div>
    <div class="location-box me-2">
      <input type="text" class="form-control pe-5" id="locationInput" placeholder="Your City or Area">
      <span class="location-icon" onclick="useMyLocation()">📍</span>
    </div>
    <button class="search-btn" onclick="searchVendors()">🔍</button>
  </div>
</div>

<!-- Vendor Listings -->
<section class="container py-3">
  <h2 class="mb-3">Popular Services</h2>
  <div id="vendorList">
    {% if vendors %}
      {% for vendor in vendors %}
        <div class="vendor-card">
          {% if vendor.photos %}
            {% set first_photo = vendor.photos.split(',')[0].strip() %}
            <img src="{{ url_for('static', filename='uploads/' ~ first_photo) }}" alt="{{ vendor.business_name }}">
          {% else %}
            <img src="{{ url_for('static', filename='uploads/default.jpg') }}" alt="Default image">
          {% endif %}
          <div class="vendor-info">
            <h6 class="fw-bold mb-1">
              <a href="/vendor/{{ vendor.phone }}" class="text-decoration-none text-dark">
                {{ vendor.business_name }}
              </a>
            </h6>
            {% if vendor.average_rating %}
              <p class="mb-1">⭐ {{ vendor.average_rating }}/5</p>
            {% else %}
              <p class="mb-1 text-muted">⭐ No ratings yet</p>
            {% endif %}
            <p class="mb-1 text-primary">🛠 {{ vendor.category }}</p>
            <p class="mb-1">🌍 {{ vendor.city }}</p>
            {% if vendor.service_hours %}
              <p class="mb-1 text-muted">⏰ {{ vendor.service_hours }}</p>
            {% endif %}
            <div class="d-flex flex-wrap gap-2 mt-2">
            {% set show_phone = vendor.subscription == "subscribed" or (now() - vendor.created_at|todatetime('%Y-%m-%d %H:%M:%S')).days <= 90 %}
            {% if show_phone %}
              <a href="tel:+91{{ vendor.phone }}" class="btn btn-call btn-sm">📞 Call</a>
            {% else %}
              <button class="btn btn-outline-secondary btn-sm" disabled>🔒 Call (Pro only)</button>
            {% endif %}
            <a href="https://wa.me/91{{ vendor.phone }}" target="_blank" class="btn btn-outline-success btn-sm">💬 WhatsApp</a>
            <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#contactModal" data-vendor="{{ vendor.business_name }}" data-phone="{{ vendor.phone }}">🔔 Callback</button>
          </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted text-center">No vendors found.</p>
    {% endif %}
  </div>
</section>

<!-- Mobile Bottom Bar -->
<div class="mobile-cta">
  <a href="/">🏠 Home</a>
  <a href="/vendor">Register</a>
  <a href="/vendor/login">Login</a>
</div>

<footer>
  <p>
    <a href="/terms">Terms</a> | <a href="/privacy">Privacy</a>
  </p>
  <p>© {{ current_year }} Helpo Services</p>
</footer>

<!-- Callback Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="callbackForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Request Callback</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="vendor_phone" id="vendorPhoneInput">
        <div class="mb-3">
          <label>Your Name</label>
          <input type="text" class="form-control" name="user_name" required>
        </div>
        <div class="mb-3">
          <label>Your Phone</label>
          <input type="text" class="form-control" name="user_phone" required>
        </div>
        <div class="mb-3">
          <label>Message</label>
          <textarea class="form-control" name="message"></textarea>
        </div>
      </div>
      <div class="modal-footer flex-column align-items-start">
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="termsCheck" required>
          <label class="form-check-label" for="termsCheck">
            I agree to <a href="/terms" target="_blank">Terms</a>
          </label>
        </div>
        <button type="submit" class="btn btn-primary w-100">Send</button>
      </div>
    </form>
  </div>
</div>

<!-- Unified script -->
<script src="/static/script.js"></script>
</body>
</html>
